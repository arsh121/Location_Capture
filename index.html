<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#D92C20">
<title>Khatabook — Share location</title>
<style>
  :root{--kb-red:#D92C20;--kb-navy:#0B2447;--kb-muted:#6B7280}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#fff,#fbfbff);font-family:Inter,system-ui,Roboto,Arial,sans-serif;color:var(--kb-navy);-webkit-tap-highlight-color:transparent}
  .app{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:env(safe-area-inset-top,22px) 16px 32px}
  .card{width:100%;max-width:900px;background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(11,36,71,0.06);border:1px solid rgba(11,36,71,0.04);display:flex;flex-direction:column;gap:12px;align-items:center}
  .logo{height:56px;object-fit:contain}
  h1{margin:0;font-size:20px;font-weight:800;text-align:center}
  .subtitle{margin:0;color:var(--kb-muted);text-align:center;font-size:15px}
  .btn{width:100%;max-width:420px;height:52px;border-radius:12px;border:0;background:var(--kb-red);color:#fff;font-weight:800;font-size:16px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(217,44,32,0.12);touch-action:manipulation}
  .btn:active{transform:translateY(1px)}
  .map-wrap{width:100%;border-radius:12px;overflow:hidden;border:1px solid rgba(11,36,71,0.06);margin-top:6px}
  #map{width:100%;height:46vh;min-height:240px}
  .confirm-wrap{width:100%;display:flex;justify-content:center;margin-top:12px}
  .loader-wrap{display:none;width:100%;margin-top:10px}
  .loader{height:10px;background:rgba(11,36,71,0.06);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--kb-red),#FF8C42);transition:width 300ms linear}
  .status{margin-top:8px;font-weight:700;color:var(--kb-navy);font-size:14px;text-align:center}
  .hidden{display:none}
  /* thanks */
  .thanks{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#fff;z-index:9999;padding:20px}
  .thanks-inner{width:100%;max-width:720px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.95));border-radius:14px;padding:28px;box-shadow:0 24px 48px rgba(11,36,71,0.08);text-align:center;display:flex;flex-direction:column;gap:14px;align-items:center}
  .hero-img{width:64%;max-width:360px;border-radius:10px;object-fit:cover;filter:drop-shadow(0 12px 30px rgba(11,36,71,0.06))}
  .ok-btn{margin-top:8px;width:140px;height:46px;background:var(--kb-red);color:#fff;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;font-weight:800;box-shadow:0 10px 30px rgba(217,44,32,0.12)}
  @media(max-width:420px){.logo{height:48px}.btn{height:50px;font-size:15px}.hero-img{width:78%}.thanks-inner{padding:20px}}
</style>
</head>
<body>
  <div class="app">
    <div class="card" id="mainCard" role="main" aria-labelledby="title">
      <img id="kbLogo" class="logo" src="logo.png" alt="Khatabook logo" onerror="this.style.display='none'">
      <h1 id="title">Share your location with Khatabook</h1>
      <p class="subtitle">We need your location to facilitate an agent visit.</p>

      <!-- initial view (only this is visible on load) -->
      <div id="initialArea" style="width:100%;display:flex;justify-content:center;margin-top:6px;">
        <button id="shareBtn" class="btn" aria-label="Share location">Share location</button>
      </div>

      <!-- afterShare is hidden inline until we set display:flex -->
      <div id="afterShare" style="width:100%;display:none;flex-direction:column;align-items:center;">
        <div class="map-wrap" id="mapWrap" style="width:100%;display:block;">
          <div id="map" aria-hidden="true"></div>
        </div>

        <div class="confirm-wrap" id="confirmWrap" style="width:100%;display:flex;justify-content:center;margin-top:12px;">
          <button id="confirmBtn" class="btn" style="max-width:360px;">Confirm</button>
        </div>

        <div id="loaderWrap" class="loader-wrap" aria-hidden="true">
          <div class="loader"><div id="loaderBar" class="bar"></div></div>
        </div>
        <div id="statusText" class="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- hidden values -->
  <input type="hidden" id="phone_hidden" />
  <input type="hidden" id="user_id" />

<script>
  // === CONFIG (apps script + maps key plugged) ===
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxBPqRZLmyIWhOxONIrH-8Ro5LgKlHvzchDEyFOkdp4SieysmFKfksHzqu05ROz9VbD/exec';
  const MAPS_API_KEY = 'AIzaSyAj3xroieTPwJcZbeXHGOZm6B-pntI3yuA';
  const FALLBACK_PHONE = '+91-99999-99999';
  const FALLBACK_USER_ID = 'default_user_12345';

  // === UI refs ===
  const shareBtn = document.getElementById('shareBtn');
  const initialArea = document.getElementById('initialArea');
  const afterShare = document.getElementById('afterShare');
  const mapWrap = document.getElementById('mapWrap');
  const confirmBtn = document.getElementById('confirmBtn');
  const loaderWrap = document.getElementById('loaderWrap');
  const loaderBar = document.getElementById('loaderBar');
  const statusText = document.getElementById('statusText');
  const phoneHidden = document.getElementById('phone_hidden');
  const userIdField = document.getElementById('user_id');
  const mainCard = document.getElementById('mainCard');

  // parse URL params quickly
  function getQueryParams(){
    const q={}; const raw = location.search.replace(/^\?/,'');
    if(!raw) return q;
    raw.split('&').forEach(pair=>{ if(!pair) return; const [k,v]=pair.split('='); try{ q[decodeURIComponent(k||'')] = decodeURIComponent(v||''); }catch(e){ q[k]=v; }});
    return q;
  }
  const params = getQueryParams();
  phoneHidden.value = params.phone || FALLBACK_PHONE;
  userIdField.value = params.user_id || FALLBACK_USER_ID;

  // map / geocode vars
  let map, marker, geocoder, currentAddress='';

  // load maps script when needed (after we have coords)
  function loadGoogleMaps(){
    return new Promise((resolve,reject)=>{
      if(window.google && window.google.maps) return resolve(window.google);
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(MAPS_API_KEY)}&libraries=places`;
      s.async = true; s.defer = true;
      s.onload = ()=> resolve(window.google);
      s.onerror = (e)=> reject(e);
      document.head.appendChild(s);
    });
  }

  // create map and geocoder
  function createMap() {
    const mapEl = document.getElementById('map');
    if(!window.google || !window.google.maps || !mapEl) return;
    mapEl.setAttribute('aria-hidden','false');
    map = new google.maps.Map(mapEl, { center:{lat:20.5937,lng:78.9629}, zoom:5, disableDefaultUI:true, gestureHandling:'greedy' });
    marker = new google.maps.Marker({ map, draggable:false });
    geocoder = new google.maps.Geocoder();
  }

  // helper to safely show afterShare
  function revealAfterShare(){
    afterShare.style.display = 'flex'; // inline show
  }

  // loader animation
  let loaderInterval = null;
  function animateLoader(){
    let pct = 0;
    loaderBar.style.width = '0%';
    loaderWrap.style.display = 'block';
    loaderInterval = setInterval(()=>{ pct += Math.random()*18; if(pct >= 98) pct = 98; loaderBar.style.width = pct + '%'; }, 300);
  }
  function stopLoader(){
    clearInterval(loaderInterval);
    loaderBar.style.width = '100%';
    setTimeout(()=>{ loaderWrap.style.display = 'none'; loaderBar.style.width = '0%'; }, 600);
  }

  function setPosition(lat,lng){
    if(!map){ setTimeout(()=>setPosition(lat,lng),150); return; }
    map.setCenter({lat:parseFloat(lat), lng:parseFloat(lng)});
    map.setZoom(16);
    marker.setPosition({lat:parseFloat(lat), lng:parseFloat(lng)});
  }

  // === SHARE button flow ===
  shareBtn.addEventListener('click', async () => {
    // disable the button and change label while asking permission
    shareBtn.disabled = true;
    const prevLabel = shareBtn.textContent;
    shareBtn.textContent = 'Requesting location…';
    statusText.textContent = '';

    if(!navigator.geolocation){
      statusText.textContent = 'Geolocation not supported by this device';
      shareBtn.disabled = false;
      shareBtn.textContent = prevLabel;
      return;
    }

    // ask for coordinates first (fastest UX): only when we have coords we load maps
    navigator.geolocation.getCurrentPosition(async (pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // now load maps & create the map
      try {
        await loadGoogleMaps();
        createMap();
        setPosition(lat,lng);
      } catch (e) {
        statusText.textContent = 'Failed to load map';
        shareBtn.disabled = false;
        shareBtn.textContent = prevLabel;
        return;
      }

      // reverse geocode (populate currentAddress), then reveal map+confirm
      try {
        geocoder.geocode({ location:{ lat, lng } }, (results, status) => {
          if(status === 'OK' && results && results.length){
            const formatted = results[0].formatted_address || '';
            let plus='';
            if(results[0].plus_code && results[0].plus_code.compound_code) plus = results[0].plus_code.compound_code;
            if(formatted) currentAddress = formatted + (plus && formatted.indexOf(plus) === -1 ? (' — '+plus) : '');
            else if(plus) currentAddress = plus;
            else currentAddress = `Lat:${lat.toFixed(6)},Lng:${lng.toFixed(6)}`;
          } else {
            currentAddress = `Lat:${lat.toFixed(6)},Lng:${lng.toFixed(6)}`;
          }
          statusText.textContent = 'Location: ' + currentAddress;
          // reveal AFTER we have geocoded and set the marker
          revealAfterShare();
          // restore shareBtn label but keep it disabled so user doesn't spam; enable if they want to retry
          shareBtn.disabled = false;
          shareBtn.textContent = prevLabel;
        });
      } catch(err){
        currentAddress = `Lat:${lat.toFixed(6)},Lng:${lng.toFixed(6)}`;
        statusText.textContent = 'Location: ' + currentAddress;
        revealAfterShare();
        shareBtn.disabled = false;
        shareBtn.textContent = prevLabel;
      }
    }, (err) => {
      // geolocation error path — show friendly message and re-enable share
      let msg = 'Location permission denied or unavailable';
      if(err && err.code === 1) msg = 'Permission denied. Please allow location access.';
      else if(err && err.code === 3) msg = 'Location request timed out. Try again.';
      statusText.textContent = msg;
      shareBtn.disabled = false;
      shareBtn.textContent = 'Share location';
      // ensure afterShare remains hidden
      afterShare.style.display = 'none';
    }, { enableHighAccuracy:true, timeout:20000, maximumAge:0 });
  });

  // === CONFIRM button ===
  confirmBtn.addEventListener('click', async () => {
    const pos = marker && marker.getPosition ? marker.getPosition() : null;
    if(!pos){ statusText.textContent = 'No location selected'; return; }
    const lat = pos.lat(), lng = pos.lng();
    const phone = (phoneHidden.value || FALLBACK_PHONE).trim();
    const user_id = userIdField.value || FALLBACK_USER_ID;

    statusText.textContent = 'Sending location…';
    animateLoader();

    const payload = new URLSearchParams();
    payload.append('address', currentAddress || '');
    payload.append('lat', lat);
    payload.append('lng', lng);
    payload.append('timestamp', new Date().toISOString());
    payload.append('phone', phone);
    payload.append('user_id', user_id);

    try {
      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload.toString()
      });
      stopLoader();
      showThanks();
    } catch (err) {
      stopLoader();
      statusText.textContent = 'Network error: ' + (err && err.message ? err.message : 'unknown');
    }
  });

  // === show thanks (full-screen) ===
  function showThanks(){
    mainCard.style.display = 'none';
    const overlay = document.createElement('div');
    overlay.className = 'thanks';
    overlay.innerHTML = `
      <div class="thanks-inner" role="status" aria-live="polite">
        <img class="hero-img" src="thank-hero.png" alt="Thanks" onerror="this.style.display='none'">
        <h1>Thanks for sharing your location</h1>
        <p class="lead">Our team will get in touch with you soon to assist with the visit.</p>
        <a class="ok-btn" id="doneBtn" href="#">Done</a>
      </div>`;
    document.body.appendChild(overlay);
    document.getElementById('doneBtn').addEventListener('click', (e) => { e.preventDefault(); try{ window.close(); }catch(e){} window.location='about:blank'; });
  }

  // hide logo if missing
  document.getElementById('kbLogo').onerror = function(){ this.style.display='none'; };
</script>
</body>
</html>
